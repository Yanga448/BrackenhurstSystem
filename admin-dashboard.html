<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Brackenhurst</title>
<link rel="stylesheet" href="css/site.css" />
</head>
<body>
  <div class="app-shell">
    <!-- Sidebar -->
    <aside class="app-sidebar">
      <div>
        <div class="brand">Brackenhurst</div>
        <nav class="nav">
          <a href="admin-dashboard.html" class="active">Dashboard</a>
          <a href="books.html">Books</a>
          <a href="users.html">Users</a>
          <a href="reports.html">Reports</a>
          <a href="logs.html">System Logs</a>
        </nav>
      </div>
      <div class="small">Logged in as Admin</div>
    </aside>

    <!-- Main Content -->
    <main class="app-main">
      <div class="header-row">
        <div>
          <div class="page-title">Admin Dashboard</div>
          <div class="small">Overview & quick actions</div>
        </div>
        <div class="row">
          <button id="btnAddUser" class="btn btn-primary">Add Staff</button>
          <button id="logout" class="btn">Logout</button>
        </div>
      </div>

      <!-- Welcome -->
      <div class="welcome" id="welcomeBox">
        <div class="txt">
          <h2 id="welcomeTitle">Welcome Admin</h2>
          <p id="welcomeSubtitle" class="card-sub">
            Manage users, subscriptions and library data.
          </p>
        </div>
      </div>

      <!-- Quick Stats -->
      <section class="stats-grid">
        <div class="card"><h3>Total users</h3><p id="statUsers">—</p></div>
        <div class="card"><h3>Total books</h3><p id="statBooks">—</p></div>
        <div class="card"><h3>Active loans</h3><p id="statLoans">—</p></div>
        <div class="card"><h3>Pending Approvals</h3><p id="statPending">—</p></div>
      </section>

      <!-- Recent Activity -->
      <section>
        <h3 style="margin-bottom:10px;">Recent Activity</h3>
        <table class="table">
          <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
          <tbody id="activityList"><tr><td colspan="4" style="text-align:center;">Loading...</td></tr></tbody>
        </table>
      </section>

      <!-- Pending Approvals -->
      <section style="margin-top: 24px;">
        <h3 style="margin-bottom:10px;">Pending User Approvals</h3>
        <table class="table">
          <thead><tr><th>Full Name</th><th>Email</th><th>Role</th><th>Action</th></tr></thead>
          <tbody id="pendingUsers"><tr><td colspan="4" style="text-align:center;">Loading...</td></tr></tbody>
        </table>
      </section>
    </main>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { 
    getFirestore, doc, getDoc, collection, onSnapshot, 
    query, orderBy, updateDoc, deleteDoc, addDoc 
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCJ07UzzIx_dIiY0WxllufSgXCj7ltXA08",
    authDomain: "brackenhurstsystem.firebaseapp.com",
    projectId: "brackenhurstsystem",
    storageBucket: "brackenhurstsystem.appspot.com",
    messagingSenderId: "98472895167",
    appId: "1:98472895167:web:5e9d1710d6b8fb5de09c0a"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentAdmin = null;

  // Auth check
  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "login.html";
    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists()) { alert("Missing user data"); return; }

    const data = snap.data();
    if (data.role !== "Admin") { alert("Not allowed here"); return window.location.href = "login.html"; }
    currentAdmin = data.fullName;
    document.getElementById("welcomeTitle").innerText = `Welcome Admin ${data.fullName}`;

    loadDashboardData();
    loadActivity();
    livePendingUsers();
  });

  // Load counts
  function loadDashboardData() {
    onSnapshot(collection(db, "users"), (snapshot) => {
      const totalUsers = snapshot.size;
      const pending = snapshot.docs.filter(d => d.data().status === "pending").length;
      document.getElementById("statUsers").innerText = totalUsers;
      document.getElementById("statPending").innerText = pending;
    });
    onSnapshot(collection(db, "books"), snap => {
      document.getElementById("statBooks").innerText = snap.size;
    });
    onSnapshot(collection(db, "loans"), snap => {
      document.getElementById("statLoans").innerText = snap.size;
    });
  }

  // Real-time activity log
  function loadActivity() {
    const q = query(collection(db, "logs"), orderBy("time", "desc"));
    onSnapshot(q, snap => {
      const tbody = document.getElementById("activityList");
      tbody.innerHTML = "";
      snap.docs.slice(0, 6).forEach(d => {
        const rec = d.data();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${new Date(rec.time).toLocaleString()}</td>
          <td>${rec.admin || "—"}</td>
          <td>${rec.action || "—"}</td>
          <td>${rec.details || "—"}</td>`;
        tbody.appendChild(row);
      });
    });
  }

  // Pending users list (live)
  function livePendingUsers() {
    const q = collection(db, "users");
    onSnapshot(q, snap => {
      const tbody = document.getElementById("pendingUsers");
      tbody.innerHTML = "";
      let hasPending = false;
      snap.forEach(d => {
        const rec = d.data();
        if (rec.status === "pending") {
          hasPending = true;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${rec.fullName}</td>
            <td>${rec.email}</td>
            <td>${rec.role}</td>
            <td>
              <button class="btn btn-primary btn-approve" data-id="${d.id}" data-name="${rec.fullName}" data-email="${rec.email}">Approve</button>
              <button class="btn btn-ghost btn-deny" data-id="${d.id}" data-name="${rec.fullName}" data-email="${rec.email}">Deny</button>
            </td>`;
          tbody.appendChild(row);
        }
      });
      if (!hasPending) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No pending users.</td></tr>`;
      }

      document.querySelectorAll(".btn-approve").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id, name = btn.dataset.name, email = btn.dataset.email;
          await updateDoc(doc(db, "users", id), { status: "approved" });
          await addDoc(collection(db, "logs"), {
            time: new Date().toISOString(),
            admin: currentAdmin,
            action: "Approved User",
            details: `Approved ${name} (${email})`
          });
          alert(`${name} approved!`);
        });
      });

      document.querySelectorAll(".btn-deny").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id, name = btn.dataset.name, email = btn.dataset.email;
          await deleteDoc(doc(db, "users", id));
          await addDoc(collection(db, "logs"), {
            time: new Date().toISOString(),
            admin: currentAdmin,
            action: "Denied User",
            details: `Denied ${name} (${email})`
          });
          alert(`${name} denied and removed.`);
        });
      });
    });
  }

  document.getElementById("logout").addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });

  document.getElementById("btnAddUser").addEventListener("click", () => {
    alert("Add Staff feature coming soon.");
  });
  </script>
</body>
</html>
