<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>My Saved eBooks — Brackenhurst Library</title>
<link rel="stylesheet" href="css/site.css">

<style>
  .ebooks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
    margin-top: 20px;
  }
  .ebook-card {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 12px;
    text-align: center;
  }
  .ebook-card img {
    width: 100%;
    height: 260px;
    object-fit: cover;
    border-radius: 8px;
  }
  .ebook-card h4 { margin: 10px 0 5px; color: #1e3a8a; }
  .ebook-card p { font-size: 14px; color: #555; }

  .btn-read, .btn-remove {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 6px;
  }
  .btn-read { background: #4f46e5; color: #fff; }
  .btn-remove { background: #ef4444; color: white; }

  #readerOverlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.85);
    display: none; flex-direction: column;
    z-index: 9999;
  }
  #readerHeader {
    background: #1e3a8a; color:white;
    padding: 12px; display:flex;
    justify-content:space-between; align-items:center;
  }
  #readerFrame { flex:1; width:100%; border:none; }
</style>
</head>
<body>

<div class="app-shell">
  <aside class="app-sidebar">
    <div>
      <div class="brand">Brackenhurst</div>
      <nav class="nav">
        <a href="user-dashboard.html">Dashboard</a>
        <a href="user-ebooks.html">eBooks</a>
        <a class="active" href="saved-ebooks.html">My Saved eBooks</a>
        <a href="borrow-books.html">Borrow Books</a>
        <a href="my-loans.html">My Loans</a>
      </nav>
    </div>
  </aside>

  <main class="app-main">
    <div class="header-row">
      <div>
        <div class="page-title">My Saved eBooks</div>
        <div class="small">Continue your reading later</div>
      </div>
    </div>

    <div class="ebooks-grid" id="savedGrid"></div>

  </main>
</div>

<div id="readerOverlay">
  <div id="readerHeader">
    <h3 id="readerTitle"></h3>
    <button id="closeReader">Close</button>
  </div>
  <iframe id="readerFrame"></iframe>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, getDocs, updateDoc, arrayRemove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = { apiKey:"AIzaSyCJ07UzzIx_dIiY0WxllufSgXCj7ltXA08", authDomain:"brackenhurstsystem.firebaseapp.com", projectId:"brackenhurstsystem", storageBucket:"brackenhurstsystem.appspot.com", messagingSenderId:"98472895167", appId:"1:98472895167:web:5e9d1710d6b8fb5de09c0a" };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

onAuthStateChanged(auth, async (user) => {
  if (!user) return location.href = "login.html";
  const snap = await getDoc(doc(db, "users", user.uid));
  currentUser = { id:user.uid, ...snap.data() };
  if (!currentUser.savedEbooks) currentUser.savedEbooks = []; // ✅ Ensure array
  loadSaved();
});

async function loadSaved() {
  const savedIds = currentUser.savedEbooks;
  const ebooksSnap = await getDocs(collection(db, "ebooks"));
  const grid = document.getElementById("savedGrid");
  grid.innerHTML = "";

  ebooksSnap.forEach(docSnap => {
    if (!savedIds.includes(docSnap.id)) return;
    const ebook = docSnap.data();
    const card = document.createElement("div");
    card.className = "ebook-card";
    card.innerHTML = `
      <img src="${ebook.coverImage || 'images/default-cover.png'}">
      <h4>${ebook.title}</h4>
      <p>${ebook.author}</p>
      <button class="btn-read" data-pdf="${ebook.pdfFile}">Read</button>
      <button class="btn-remove" data-id="${docSnap.id}">Remove</button>
    `;
    grid.appendChild(card);
  });

  bindEvents();
}

function bindEvents() {
  document.querySelectorAll(".btn-read").forEach(btn => {
    btn.onclick = () => {
      if (currentUser.verificationStatus !== "approved") {
        alert("You must complete verification before reading eBooks.");
        return;
      }
      const data = btn.dataset.pdf;
      const blob = dataUrlToBlob(data);
      const url = URL.createObjectURL(blob);
      document.getElementById("readerFrame").src = url + "#toolbar=0";
      document.getElementById("readerOverlay").style.display = "flex";
    };
  });

  document.querySelectorAll(".btn-remove").forEach(btn => {
    btn.onclick = async () => {
      await updateDoc(doc(db,"users",currentUser.id),{ savedEbooks: arrayRemove(btn.dataset.id) });
      loadSaved();
    };
  });

  document.getElementById("closeReader").onclick = () => {
    document.getElementById("readerOverlay").style.display = "none";
    document.getElementById("readerFrame").src = "";
  };
}

function dataUrlToBlob(dataUrl) {
  const [meta, base64] = dataUrl.split(',');
  const mime = meta.match(/data:(.*);base64/)[1];
  const bytes = atob(base64);
  const array = new Uint8Array(bytes.length);
  for(let i=0;i<bytes.length;i++) array[i] = bytes.charCodeAt(i);
  return new Blob([array], { type: mime });
}
</script>

</body>
</html>
