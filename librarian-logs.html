<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Librarian Logs — Brackenhurst Library</title>
<link rel="stylesheet" href="css/site.css" />

<style>
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    background-color: #f9fafb;
    color: #111827;
  }

  .table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  .table th, .table td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; text-align: left; }
  .btn { padding: 8px 12px; border-radius: 8px; cursor: pointer; }
  .btn-primary { background: #4f46e5; color: #fff; border: none; }
  .btn-ghost { background: transparent; border: 1px solid #e5e7eb; }
  .small { font-size: 13px; color: #6b7280; }
  .card { background: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); margin-top: 10px; }
  #searchInput, #timeFilter {
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
  }
</style>
</head>

<body>
  <div class="app-shell">
    <!-- Sidebar -->
    <aside class="app-sidebar">
      <div>
        <div class="brand">Brackenhurst</div>
        <nav class="nav">
          <a href="librarian-dashboard.html">Dashboard</a>
          <a href="librarian-books.html">Books</a>
          <a href="librarian-ebooks.html">eBooks</a>
          <a href="ebook-subscriptions.html">eBook Subscriptions</a>
          <a href="loan-subscriptions.html">Loan Subscriptions</a>
          <a href="loans.html">Loans</a>
          <a href="members.html">Members</a>
          <a href="librarian-logs.html" class="active">Logs</a>
        </nav>
      </div>
      <div class="small">Logged in as Librarian</div>
    </aside>

    <!-- Main -->
    <main class="app-main">
      <div class="header-row">
        <div>
          <div class="page-title">Librarian Logs</div>
          <div class="small">View and filter librarian actions by time and keywords</div>
        </div>
        <div class="row" style="gap:10px;">
          <select id="timeFilter">
            <option value="all">All Time</option>
            <option value="7">Last 7 Days</option>
            <option value="21">Last 21 Days</option>
            <option value="90">Last 3 Months</option>
          </select>
          <input type="text" id="searchInput" placeholder="Search by action or details..." />
          <button id="refreshBtn" class="btn btn-primary">Refresh</button>
          <button id="logout" class="btn">Logout</button>
        </div>
      </div>

      <!-- Logs Table -->
      <section class="card">
        <h3>Recent Activities</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Date & Time</th>
              <th>Action</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="logsTable">
            <tr><td colspan="3" style="text-align:center;">Loading logs...</td></tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCJ07UzzIx_dIiY0WxllufSgXCj7ltXA08",
    authDomain: "brackenhurstsystem.firebaseapp.com",
    projectId: "brackenhurstsystem",
    storageBucket: "brackenhurstsystem.appspot.com",
    messagingSenderId: "98472895167",
    appId: "1:98472895167:web:5e9d1710d6b8fb5de09c0a"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let allLogs = [];

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "login.html";

    const res = await fetch(`https://firestore.googleapis.com/v1/projects/brackenhurstsystem/databases/(default)/documents/users/${user.uid}`);
    const json = await res.json();
    const data = json.fields;
    if (!data || data.role.stringValue !== "Librarian") {
      alert("Access denied. Librarians only.");
      return window.location.href = "login.html";
    }

    loadLogs();
  });

  async function loadLogs() {
    const tbody = document.getElementById("logsTable");
    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;">Loading...</td></tr>`;
    const qSnap = await getDocs(query(collection(db, "librarianLogs"), orderBy("time", "desc")));
    allLogs = qSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderLogs(allLogs);
  }

  function renderLogs(list) {
    const tbody = document.getElementById("logsTable");
    if (list.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;">No logs found.</td></tr>`;
      return;
    }
    tbody.innerHTML = "";
    list.forEach(log => {
      const tr = document.createElement("tr");
      const date = new Date(log.time);
      tr.innerHTML = `
        <td>${date.toLocaleString()}</td>
        <td>${log.action || "—"}</td>
        <td>${log.details || "—"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Search filter
  document.getElementById("searchInput").addEventListener("input", e => {
    filterLogs();
  });

  // Time filter
  document.getElementById("timeFilter").addEventListener("change", e => {
    filterLogs();
  });

  function filterLogs() {
    const queryText = document.getElementById("searchInput").value.toLowerCase();
    const timeValue = document.getElementById("timeFilter").value;

    const now = new Date();
    let filtered = allLogs;

    // Time filtering logic
    if (timeValue !== "all") {
      const days = parseInt(timeValue);
      const cutoff = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
      filtered = filtered.filter(log => new Date(log.time) >= cutoff);
    }

    // Keyword filtering
    filtered = filtered.filter(l =>
      (l.action || "").toLowerCase().includes(queryText) ||
      (l.details || "").toLowerCase().includes(queryText)
    );

    renderLogs(filtered);
  }

  // Refresh
  document.getElementById("refreshBtn").addEventListener("click", loadLogs);

  // Logout
  document.getElementById("logout").addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });
  </script>
</body>
</html>
