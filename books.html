<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Books — Brackenhurst</title>
<link rel="stylesheet" href="css/site.css" />
<style>
  .cover-thumb {
    width: 50px;
    height: 70px;
    object-fit: cover;
    border-radius: 4px;
  }
</style>
</head>
<body>
  <div class="app-shell">
    <!-- Sidebar -->
    <aside class="app-sidebar">
      <div>
        <div class="brand">Brackenhurst</div>
        <nav class="nav">
          <a href="admin-dashboard.html">Dashboard</a>
          <a href="books.html" class="active">Books</a>
          <a href="users.html">Users</a>
          <a href="reports.html">Reports</a>
          <a href="logs.html">System Logs</a>
        </nav>
      </div>
      <div class="small">Logged in as Admin</div>
    </aside>

    <!-- Main -->
    <main class="app-main">
      <div class="header-row">
        <div>
          <div class="page-title">Books Management</div>
          <div class="small">View, add, or update books in the library</div>
        </div>
        <div class="row">
          <button id="btnAddBook" class="btn btn-primary">Add Book</button>
          <button id="logout" class="btn">Logout</button>
        </div>
      </div>

      <!-- Add/Edit Form -->
      <div id="bookForm" class="card" style="display:none; margin:15px 0;">
        <h3 id="formTitle">Add New Book</h3>
        <form id="bookEditor">
          <input type="text" id="bookTitle" placeholder="Book title" required />
          <input type="text" id="bookAuthor" placeholder="Author name" required />
          <input type="text" id="bookCategory" placeholder="Category" required />
          <input type="number" id="bookCopies" placeholder="Available copies" required />
          <label for="bookCover" class="small">Upload Cover Image:</label>
          <input type="file" id="bookCover" accept="image/*" />
          <button type="submit" class="btn btn-primary" id="saveBookBtn">Save Book</button>
          <button type="button" class="btn btn-ghost" id="cancelEdit">Cancel</button>
        </form>
      </div>

      <!-- Books Table -->
      <section>
        <h3>Books List</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Cover</th><th>Title</th><th>Author</th><th>Category</th><th>Copies</th><th>Added By</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="booksTable">
            <tr><td colspan="7" style="text-align:center;">Loading books...</td></tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc 
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCJ07UzzIx_dIiY0WxllufSgXCj7ltXA08",
    authDomain: "brackenhurstsystem.firebaseapp.com",
    projectId: "brackenhurstsystem",
    storageBucket: "brackenhurstsystem.appspot.com",
    messagingSenderId: "98472895167",
    appId: "1:98472895167:web:5e9d1710d6b8fb5de09c0a"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentAdmin = null;
  let editMode = null;
  let coverImageBase64 = "";

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "login.html";
    const res = await fetch(`https://firestore.googleapis.com/v1/projects/brackenhurstsystem/databases/(default)/documents/users/${user.uid}`);
    const json = await res.json();
    const data = json.fields;
    if (!data || data.role.stringValue !== "Admin") {
      alert("Access denied. Admins only.");
      return window.location.href = "login.html";
    }
    currentAdmin = data.fullName.stringValue;
    loadBooks();
  });

  // Convert image to Base64 when uploaded
  document.getElementById("bookCover").addEventListener("change", function() {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onloadend = function() {
      coverImageBase64 = reader.result;
    };
    reader.readAsDataURL(file);
  });

  async function loadBooks() {
    const snap = await getDocs(collection(db, "books"));
    const tbody = document.getElementById("booksTable");
    tbody.innerHTML = "";
    snap.forEach(docSnap => {
      const book = docSnap.data();
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${book.coverImage ? `<img src="${book.coverImage}" class="cover-thumb" />` : "—"}</td>
        <td>${book.title}</td>
        <td>${book.author}</td>
        <td>${book.category}</td>
        <td>${book.copies}</td>
        <td>${book.addedBy || "—"}</td>
        <td>
          <button class="btn btn-ghost btn-edit" data-id="${docSnap.id}">Edit</button>
          <button class="btn btn-ghost btn-delete" data-id="${docSnap.id}">Delete</button>
        </td>
      `;
      tbody.appendChild(row);
    });
    bindBookButtons();
  }

  function bindBookButtons() {
    document.querySelectorAll(".btn-edit").forEach(btn => {
      btn.addEventListener("click", async () => {
        editMode = btn.dataset.id;
        const snap = await getDocs(collection(db, "books"));
        snap.forEach(s => {
          if (s.id === editMode) {
            const b = s.data();
            document.getElementById("bookTitle").value = b.title;
            document.getElementById("bookAuthor").value = b.author;
            document.getElementById("bookCategory").value = b.category;
            document.getElementById("bookCopies").value = b.copies;
            coverImageBase64 = b.coverImage || "";
          }
        });
        document.getElementById("formTitle").innerText = "Edit Book";
        document.getElementById("bookForm").style.display = "block";
      });
    });

    document.querySelectorAll(".btn-delete").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        await deleteDoc(doc(db, "books", id));
        alert("Book deleted.");
        loadBooks();
      });
    });
  }

  document.getElementById("btnAddBook").addEventListener("click", () => {
    editMode = null;
    document.getElementById("formTitle").innerText = "Add New Book";
    document.getElementById("bookForm").style.display = "block";
    document.getElementById("bookEditor").reset();
    coverImageBase64 = "";
  });

  document.getElementById("cancelEdit").addEventListener("click", () => {
    document.getElementById("bookForm").style.display = "none";
  });

  document.getElementById("bookEditor").addEventListener("submit", async (e) => {
    e.preventDefault();
    const title = document.getElementById("bookTitle").value.trim();
    const author = document.getElementById("bookAuthor").value.trim();
    const category = document.getElementById("bookCategory").value.trim();
    const copies = parseInt(document.getElementById("bookCopies").value);

    if (editMode) {
      await updateDoc(doc(db, "books", editMode), {
        title, author, category, copies, coverImage: coverImageBase64
      });
      alert("Book updated.");
    } else {
      await addDoc(collection(db, "books"), {
        title, author, category, copies,
        coverImage: coverImageBase64,
        addedBy: currentAdmin,
        createdAt: new Date().toISOString()
      });
      alert("Book added.");
    }
    document.getElementById("bookForm").style.display = "none";
    loadBooks();
  });

  document.getElementById("logout").addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });
  </script>
</body>
</html>
